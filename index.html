<script>

const chat = document.getElementById("chat");

function scrollToBottom(){
    setTimeout(() => {
        chat.scrollTop = chat.scrollHeight;
    }, 50);
}

function addMessage(html, role="ai"){

    const wrapper = document.createElement("div");
    wrapper.className="message";

    wrapper.innerHTML = `
        <div class="avatar">${role === "user" ? "Vi" : "AI"}</div>
        <div class="bubble">${html}</div>
    `;

    chat.appendChild(wrapper);
    scrollToBottom();
}

async function sendMessage(){

    const input = document.getElementById("input");
    const message = input.value.trim();
    if(message === "") return;

    addMessage(message, "user");

    const thinking = document.createElement("div");
    thinking.className="message";
    thinking.innerHTML = `
        <div class="avatar">AI</div>
        <div class="bubble"><em>Razmišljam...</em></div>
    `;
    chat.appendChild(thinking);
    scrollToBottom();

    try {

        const response = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message })
        });

        const data = await response.json();

        chat.removeChild(thinking);

        let html = `<h2>${data.title}</h2>`;
        html += `<p>${data.intro}</p><ul>`;

        data.recommendations.forEach(r => {
            html += `<li><strong>${r.name}</strong><br>${r.reason}</li>`;
        });

        html += `</ul>`;
        html += `<p><em>${data.followUpQuestion}</em></p>`;

        addMessage(html);

    } catch(error){
        chat.removeChild(thinking);
        addMessage("Došlo je do pogreške.");
    }

    input.value="";
}

document.getElementById("input").addEventListener("keypress", function(e){
    if(e.key === "Enter"){
        sendMessage();
    }
});

window.onload = scrollToBottom;

</script>
